{% extends 'miningtaxes/base.html' %}
{% load i18n %}
{% load static %}
{% load humanize %}
{% load evelinks %}

{% block details %}
<div class="row">
	<div class="col-md-12">
    		<div class="panel panel-default">
			<div class="panel-heading" style="display:flex;">
			    <h3 class="panel-title">Taxes by User</h3>
			</div>
			<div class="panel-body">
    <div class="table-responsive">
        <table class="table table-striped table-width-fix" id="mains">
            <thead>
                <tr>
                    <th>{% translate 'Name' %}</th>
                    <th>{% translate 'Corp' %}</th>
                    <th>{% translate 'Balance' %}</th>
                    <th>{% translate 'Last Paid' %}</th>
		    <th>{% translate 'Actions' %}</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
			</div>
		</div>
	</div>
</div>
<div class="row">
	<div class="col-md-12">
    		<div class="panel panel-default">
			<div class="panel-heading" style="display:flex;">
			    <h3 class="panel-title">Taxes by Character</h3>
			</div>
			<div class="panel-body">
    <div class="table-responsive">
        <table class="table table-striped table-width-fix" id="chars">
            <thead>
                <tr>
                    <th>{% translate 'Name' %}</th>
                    <th>{% translate 'Corp' %}</th>
                    <th>{% translate 'Main' %}</th>
                    <th>{% translate 'Taxes' %}</th>
                    <th>{% translate 'Credits' %}</th>
                    <th>{% translate 'Balance' %}</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
			</div>
		</div>
	</div>
</div>

<div class="modal" id="modalCredit" tabindex="-1" role="dialog" aria-labelledby="modalCredit">
    <div class="modal-dialog  modal-sm" role="document" id="modalCredit">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">
                    &times;
                </span></button>
                <h4 class="modal-title" id="myModalLabel">Tax Credits</h4>
            </div>

	    <form class="form-horizontal" method=POST action="{% url 'miningtaxes:admin_tables' %}">
            {% csrf_token %}
            <div class="modal-body">
			    <div class="form-group">
				    <label for="user">Recipient:</label>
				    <span id="user"></span>
				    <input type="hidden" id="userid" name="userid">
			    </div>
			    <div class="form-group">
				    <label for="creditbox">Tax credit amount:</label>
				    <input type="text" class="form-control" id="creditbox" name="creditbox">
			    </div>
            </div>

            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">
                    {% translate 'Submit' %}
                </button>
            </div>
	    </form>
        </div>
    </div>
</div>

{% endblock details %}

{% block extra_javascript %}
{% include 'bundles/datatables-js.html' %}
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'miningtaxes/css/global.css' %}" type="text/css">
    <link rel="stylesheet" href="{% static 'miningtaxes/css/miningtaxes.css' %}" type="text/css">
    <link rel="stylesheet" href="{% static 'miningtaxes/css/launcher.css' %}" type="text/css">
{% endblock %}

{% block extra_script %}
var user_data;
var user_table;

function populate(rowi) {
	console.log(user_data[rowi]);
	$("#user").html(user_data[rowi].name);
	$("#userid").val(user_data[rowi].user);
	$("#creditbox").val(user_data[rowi].balance);
}

$(document).ready(function () {
	$.getJSON("{% url 'miningtaxes:admin_main_json' %}", function (d) {
		user_data = d["data"];
		user_data.forEach( function(row) {
			user_table.row.add(row);
		});
		user_table.draw();
	});
        user_table = $('#mains').DataTable({
            columns: [
                { data: 'name' },
                { data: 'corp' },
                {
                    data: 'balance',
                    render: $.fn.dataTable.render.number(',', '.', 2)
                },
		{ data: 'last_paid' },
		{ data: 'action' },
            ],
            order: [[2, "desc"]]
        });
        $('#chars').DataTable({
            ajax: {
                url: "{% url 'miningtaxes:admin_char_json' %}",
                dataSrc: 'data',
                cache: false
            },
            columns: [
                { data: 'name' },
                { data: 'corp' },
                { data: 'main_name' },
                {
                    data: 'taxes',
                    render: $.fn.dataTable.render.number(',', '.', 2)
                },
                {
                    data: 'credits',
                    render: $.fn.dataTable.render.number(',', '.', 2)
                },
                {
                    data: 'balance',
                    render: $.fn.dataTable.render.number(',', '.', 2)
                }
            ],
            order: [[5, "desc"]]
        });
});
{% endblock %}
